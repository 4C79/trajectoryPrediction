Project : trajectoryPrediction 2022
**背景**

```
通过使用双目相机拍摄目标飞行轨迹来预测其三维落点
```

**功能**

```
1. 相机标定 （./calibration/calibration.py ）
2. 视频分帧 （./detect/cutVideo.py）
3. 拍摄数据，以（640，480）分辨率保持图片 保证在40帧左右 （./camera/cv_grab.py/getData）
4. 检测黑色圆球，通过 cv2.HoughCircles 函数调整参数保证检测到目标 (./detect/blackCircle_Finder.py)
5. 通过文件读取图片数据，扫描文件夹内所有图片，只有当左右目同时检测到目标时会记录计算 (./detect/placement_prediction.py)
6. 使用kalman Filter进行轨迹预测，达到演示效果 (./detect/kalmanfilter.py)
7. 使用Epnp对固定场景下的4组控制点进行计算，从而求出目标三维坐标 (./detect/EPNP.py/calculate)
8. 通过LSM拟合三维坐标，预估目标落点 (./detect/LSM.py/lsm)
9. 软件界面演示 （display.py）
```

**不足**

```
1. 标定板不够精确，不能保证平整
2. 不能保证左右目 高帧且同步（70fps），暂时是电脑的存储速率限制了帧率（即可通过降低图片保存的质量来增加帧率，
但这引出新的问题，即像素空间被压缩，会导致计算误差增加）。如何通过硬件同步（同步器）
3. 圆球检测时，时常失败，需要调参（如何优化此过程 1.先处理，找出最优阈值（基本失败，有些无法圆无法检测出，受环境影响较大）
   2.处理完毕后，将检测失败的圆去除(√)，通过kalman补帧（无法保证kalman预测的左右目时刻一致，三维kalman暂时无法写出）
   使用yolo等检测算法寻找目标（尝试使用yolov7？yolov5是肯定可以）
4. 自动检测目标时，如何处理 误检（可以通过目标三维坐标的梯度下降来判断，暂时未做），漏检 问题（跳过）
5. 如何减少Epnp计算所产生的误差 （尝试改变相机内参带来的误差，已尝试修正像素中心，能够提升一些精度）
6. LSM拟合效果如何？考虑LESM？（理论上来讲，拟合的点越多落点预测的越准确，但是这也会提高每次EPNP计算误差所带来的影响，
    LESM是通过网络回归的方法计算，需要一定数据量来训练参数模型）
7. 优化软件界面 （需要学习CSS，暂时搁置）
```

**误差**

```
测试结果： 
	data4  预测坐标（33，49），实际坐标 （20，25）
	data5  预测坐标（45，-17），实际坐标 （42，-30）
	data6  预测坐标（34，-13），实际坐标 （10，-25）
原标定图片1936*1464的像素，但是在拍摄数据时为了让保存的帧数增加，将照片resize为（640，480），所以再进行EPNP计算时，会增加误差（矩阵元素减少，计算误差增大）
    resize后， [-33,60,0] 被计算为 [-25，67，-10]
    原图 ，    [-33,60,0] 被计算为 [-45，63，-4]
    修改l的像素中心 [-44,63,-3] ,修改r的像素中心 [-57,68,-11] 都修改 [-56,68,-10]
opencv标定后测试如下：
	原图 ：  [-33,60,0] 被计算为 [-20，55，7.39]
	修改l像素中心 [-20,55,7.2] 修改r像素中心 [-48,64,-8] 都修改后 [-47,64,-8.2]
```

**硬件参数**

```
处理器 ：i7-6700 CPU@ 3.4GHz 
内存RAM ：16G
操作系统：window7 64位（采集数据机器）
硬盘： 希捷1000G机械硬盘
相机： 万兆网传输相机 * 2 ，帧率最高可达300多帧，黑白相机，最高像素1936*1464 
        分别配有 PcIe3 * 16 ,PcIe3 * 4 的网卡（PCIe属于高速串行点对点双通道高带宽传输）
显卡： 英伟达 NVS 315 （未用到）
```

**技术原理**

```
相机标定   ： 使用张正友相机标定发，通过python或matlab实现
相机同步帧 ：通过python同一线程控制，相对来说是很一致的时间
目标识别  ：检测黑色乒乓球是通过滤波之后使用霍夫圆检测
坐标计算 ： 首先手动标记像素-世界坐标系的4组控制点，分别计算出左右目相机位姿，反算目标点世界坐标
演示效果 ： 通过kalman Filter预测目标下一帧位置，将整个轨迹绘制到同一张图片上来展示
轨迹拟合 ： 通过三维坐标点集，使用LSM来拟合方程
落点预测 ： 即当LSM拟合方程Z=0的情况。
```

**环境**

```
certifi           2022.6.15
click             7.1.2
cycler            0.11.0
fonttools         4.34.4
imutils           0.5.4
kiwisolver        1.4.3
matplotlib        3.5.2
numpy             1.21.6
opencv-python     3.4.11.39
packaging         21.3
Pillow            9.2.0
pip               22.1.2
pyparsing         3.0.9
PyQt5             5.15.4
pyqt5-plugins     5.15.4.2.2
PyQt5-Qt5         5.15.2
PyQt5-sip         12.11.0
pyqt5-tools       5.15.4.3.2
python-dateutil   2.8.2
python-dotenv     0.20.0
qt5-applications  5.15.2.2.2
qt5-tools         5.15.2.1.2
scipy             1.7.3
setuptools        63.1.0
six               1.16.0
typing_extensions 4.3.0
wheel             0.37.1
wincertstore      0.2
```

